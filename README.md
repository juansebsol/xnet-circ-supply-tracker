# XNET Circulating Supply Scraper

Automated on‚Äëchain fetcher that:
- Pulls XNET token **total supply** from the mint.
- Sums balances across a maintained list of **locked wallets**.
- Computes **circulating supply = total ‚Äì locked**.
- Stores timestamped snapshots in **Supabase**.
- Logs each job run for audit/debug.
- (Optional) Exposes a **public read‚Äëonly API** on Vercel (latest, history, summary) ‚Äî same DX style as the Offload Data Scraper project.

---

## ‚öôÔ∏è How It Works

1. **Connect to Solana RPC**
   - Use your Helius (or other) endpoint; configurable via `RPC_URL`.
2. **Fetch Token Mint Supply**
   - One call to `getTokenSupply(mint)` returns raw amount + decimals.
3. **Load Locked Wallet List**
   - From repo JSON (`/data/locked-wallets.json`) or override via `LOCKED_WALLETS_JSON` env (path or URL).
4. **Batch Wallet Balance Checks (Rate‚ÄëLimited)**
   - Configurable `BATCH_SIZE`, `BATCH_DELAY_MS`, retry w/ backoff.
5. **Compute Circulating Supply**
   - `circulating = total - locked`.
6. **Write Results to Supabase**
   - Snapshot row ‚Üí `circ_supply`.
   - Per‚Äëwallet current balance cache ‚Üí `circ_wallet_balances`.
   - Run log (success/error, RPC count) ‚Üí `circ_log`.
   - This mirrors the *parse ‚Üí upsert ‚Üí log* flow pattern you used in the Offload Scraper.
7. **Schedule via GitHub Actions**
   - Hourly cron + manual dispatch; secrets injected in workflow. Same ops model as Offload Scraper.
8. **Optional Vercel API**
   - Lightweight Node serverless endpoints for latest / range / summary; Supabase service role envs set in Vercel, just like Offload API.

---

## üóÇÔ∏è Project Structure

```
xnet-circ-supply-scraper/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ runOnce.js           # Entry point for local + CI one-shot
‚îÇ   ‚îú‚îÄ‚îÄ fetchSupply.js       # Fetch total, locked, compute circ
‚îÇ   ‚îú‚îÄ‚îÄ upsert.js            # Supabase writes + run logging
‚îÇ   ‚îú‚îÄ‚îÄ supabase.js          # Supabase admin client (server-only)
‚îÇ   ‚îú‚îÄ‚îÄ lockedWallets.js     # Load + validate locked wallet list
‚îÇ   ‚îî‚îÄ‚îÄ mintInfo.js          # Mint decimals helper (optional cache)
‚îÇ
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ locked-wallets.json  # Versioned locked wallet list
‚îÇ
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ circ-supply.yml  # GitHub Action cron + manual run
‚îÇ
‚îú‚îÄ‚îÄ api/                     # Optional public read API (Vercel)
‚îÇ   ‚îú‚îÄ‚îÄ _supabase.js         # Admin client (read-only queries)
‚îÇ   ‚îú‚îÄ‚îÄ _util.js             # Format helpers (units, % locked)
‚îÇ   ‚îú‚îÄ‚îÄ latest.js            # Most recent snapshot
‚îÇ   ‚îú‚îÄ‚îÄ history.js           # Range / limit query
‚îÇ   ‚îú‚îÄ‚îÄ summary.js           # Avg circ, min/max, % locked
‚îÇ   ‚îî‚îÄ‚îÄ vercel.json          # Vercel runtime config
‚îÇ
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ supa-sql-migrate.txt     # Safe create/alter tables
‚îÇ   ‚îî‚îÄ‚îÄ supa-sql-destructive.txt # Drop + recreate (dev reset)
‚îÇ
‚îú‚îÄ‚îÄ .env.sample
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ jsconfig.json               # Or tsconfig if using TypeScript
```

The structure intentionally mirrors the clean layout from **xnet‚Äëoffload‚Äëscraper** (src scraper logic, Supabase client, upsert + log module, GitHub workflow, optional API).

---

## üîê Environment Variables

Create a `.env` at repo root (never commit). These same Supabase + runtime env patterns are used in the Offload Scraper project, so this will feel familiar.

```bash
# Supabase
SUPABASE_URL="https://YOUR-PROJECT.supabase.co"
SUPABASE_SERVICE_ROLE_KEY="your-service-role-key"

# Solana RPC + Token
RPC_URL="https://mainnet.helius-rpc.com/?api-key=YOURKEY"
TOKEN_MINT="xNETbUB7cRb3AAu2pNG2pUwQcJ2BHcktfvSB8x1Pq6L"

# Locked wallets (path or URL)
LOCKED_WALLETS_JSON="./data/locked-wallets.json"

# Rate-limit tuning
BATCH_SIZE=5
BATCH_DELAY_MS=1000
MAX_RPC_RETRIES=3

# Logging
LOG_LEVEL=info
```

| Var                     | Required | What it‚Äôs for                | Notes                                              |
|-------------------------|----------|------------------------------|----------------------------------------------------|
| SUPABASE_URL            | ‚úÖ       | Supabase instance URL        | Server‚Äëonly. Same usage pattern in Offload Scraper. |
| SUPABASE_SERVICE_ROLE_KEY| ‚úÖ      | Admin key (insert/update)    | Store in GitHub & Vercel env; never client‚Äëside.    |
| RPC_URL                 | ‚úÖ       | Solana RPC endpoint          | Use Helius or other high‚Äëlimit RPC.                 |
| TOKEN_MINT              | ‚úÖ       | XNET SPL token mint address  | Raw base units pulled from chain.                   |
| LOCKED_WALLETS_JSON     | ‚ûñ       | Override path/URL            | If unset, uses repo file.                           |
| BATCH_SIZE              | ‚ûñ       | Wallets per RPC batch        | Helps avoid rate limits.                            |
| BATCH_DELAY_MS          | ‚ûñ       | Wait between batches         | Increase if 429 errors.                             |
| MAX_RPC_RETRIES         | ‚ûñ       | Retry attempts               | Exponential backoff.                                |
| LOG_LEVEL               | ‚ûñ       | debug/info/warn/error        | Local verbosity.                                    |

---

## üß™ Run Locally

Runs full process once locally `npm run circ:once`

```bash
npm install        # first time; or npm ci in CI
cp .env.sample .env
# edit .env with Supabase + RPC + mint
node -e "console.log('env loaded ok')"   # (optional sanity)

# Run once
npm run circ:once
```

Expected console output:

```json
‚úÖ Circulating supply job OK
{
  "ts": "2025-07-23T17:00:00.000Z",
  "total": "250000000000000",
  "locked": "120000000000000",
  "circ": "130000000000000",
  "walletsChecked": 37,
  "rpcCalls": 52,
  "ms": 3200
}
```
If it fails, see Troubleshooting below.

---

## üßæ Supabase Schema (SQL)

Run the safe create script first: open `utils/supa-sql-migrate.txt` in the Supabase SQL editor and execute. This pattern (bundled SQL file, paste into Supabase UI) is the same flow used in the Offload Scraper README.

**Safe Create / Migrate**

```sql
create extension if not exists "uuid-ossp";
create extension if not exists pgcrypto;

create table if not exists public.circ_supply (
  id uuid primary key default gen_random_uuid(),
  ts timestamptz not null default now(),
  total_supply numeric not null,
  locked_balance numeric not null,
  circulating_supply numeric not null,
  pct_locked numeric generated always as (
    case when total_supply > 0 then locked_balance / total_supply * 100 else null end
  ) stored
);
create index if not exists circ_supply_ts_idx on public.circ_supply (ts desc);

create table if not exists public.circ_wallet_balances (
  wallet text primary key,
  balance numeric not null,
  last_updated timestamptz not null default now()
);

create table if not exists public.circ_log (
  id uuid primary key default gen_random_uuid(),
  ts timestamptz not null default now(),
  status text,
  total_supply numeric,
  locked_balance numeric,
  circulating_supply numeric,
  wallets_checked int,
  rpc_calls int,
  error text
);
```

**Destructive Reset (Dev Only!)**

Drops all circulating‚Äësupply tables. Only use when rebuilding from scratch ‚Äî same warning style as Offload Scraper destructive schema note.

```sql
begin;
  drop table if exists public.circ_log cascade;
  drop table if exists public.circ_wallet_balances cascade;
  drop table if exists public.circ_supply cascade;
commit;
-- then run the migrate SQL above
```

---

## üß† Logic Summary

**runJob()** (from `src/fetchSupply.js`)
- Load env/config.
- Fetch total token supply.
- Load locked wallet list.
- Batch fetch each wallet balance (parsed token accounts first; fallback path).
- Sum locked; calc circ.
- Insert snapshot row.
- Upsert per‚Äëwallet balances.
- Log run metrics (`circ_log`).

**insertSupplySnapshot() / upsertWalletBalances() / logCircRun()** (from `src/upsert.js`)
- Direct Supabase writes.
- Log status + counts for audit (mirrors the upsertDaily() + logScrape() approach in Offload Scraper).

---

## ‚úÖ Usage Summary

| Action                | Command / Method         |
|-----------------------|-------------------------|
| Local one‚Äëshot        | npm run circ:once       |
| GitHub hourly cron    | Auto via Actions (circ-supply.yml) |
| Setup Supabase schema | Paste migrate SQL into Supabase |
| Update locked wallets | Edit /data/locked-wallets.json or provide URL in env |
| Public read API       | Deploy repo to Vercel (optional) |

---

## ‚è± GitHub Actions (Scheduled Job)

A workflow in `.github/workflows/circ-supply.yml` runs the job hourly (top of hour UTC) and can be triggered manually in the Actions tab. This mirrors the Offload project‚Äôs CI scheduling pattern.

**circ-supply.yml**

```yaml
name: Circulating Supply Hourly

on:
  schedule:
    - cron: '0 * * * *'   # top of every hour UTC
  workflow_dispatch:

jobs:
  circ-supply:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    concurrency:
      group: circ-supply
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Run circulating supply fetch
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          RPC_URL: ${{ secrets.RPC_URL }}
          TOKEN_MINT: ${{ secrets.TOKEN_MINT }}
          LOCKED_WALLETS_JSON: ${{ secrets.LOCKED_WALLETS_JSON }} # optional URL override
          BATCH_SIZE: 5
          BATCH_DELAY_MS: 1000
          MAX_RPC_RETRIES: 3
          LOG_LEVEL: info
        run: npm run circ:once

      # Optional debug artifact
      - name: Upload run artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: circ-supply-run
          path: run-output/**
          if-no-files-found: ignore
          retention-days: 7
```

Add Secrets: GitHub ‚Üí Repo ‚Üí Settings ‚Üí Secrets & Variables ‚Üí Actions. Same flow as the Offload Scraper GitHub Action env setup.

---

## üåê Public Read API (Optional / Vercel)

This project includes an optional public JSON API, deployable via Vercel.

---

üîó **Base URL**

Once deployed, your API will be accessible at:

```
https://your-vercel-deployment.vercel.app/api
```

> **Tip:** You can test locally by hitting `http://localhost:3000/api/*` if using `vercel dev`.

---

üóÇÔ∏è **API Source Layout**

```
api/
‚îú‚îÄ‚îÄ _supabase.js     # Shared Supabase admin client
‚îú‚îÄ‚îÄ _util.js         # Format helpers (units, %)
‚îú‚îÄ‚îÄ latest.js        # Latest supply snapshot
‚îú‚îÄ‚îÄ history.js       # Supply snapshots by limit or range
‚îú‚îÄ‚îÄ summary.js       # Summary (avg, min, max)
‚îî‚îÄ‚îÄ vercel.json      # Runtime config
```

---

üîê **Required Environment Variables (Vercel)**

Only Supabase keys are needed for read access ‚Äî no RPC or GitHub secrets.

| Variable                   | Required | Description                        |
|---------------------------|----------|------------------------------------|
| SUPABASE_URL              | ‚úÖ       | Your Supabase project URL          |
| SUPABASE_SERVICE_ROLE_KEY | ‚úÖ       | Service role key (read-only use)   |
| TOKEN_DECIMALS            | ‚ûñ       | Optional override for formatting   |

Add these in the Vercel dashboard: **Project ‚Üí Settings ‚Üí Environment Variables**

---

üöÄ **Deployment Steps (Vercel)**

1. Commit the `api/` folder and `vercel.json` to your repo.
2. Push to GitHub (or connect Git repo to Vercel).
3. Import the project in Vercel.
4. Set the required environment variables.
5. Deploy.

---

üì° **Endpoints**

| Endpoint                                    | Description                        | Example                                      |
|---------------------------------------------|------------------------------------|----------------------------------------------|
| `/api/latest`                               | Most recent supply snapshot        | `/api/latest`                                |
| `/api/history?limit=10`                     | Last N rows (descending)           | `/api/history?limit=10`                      |
| `/api/history?start=YYYY-MM-DD&end=YYYY-MM-DD` | Date range snapshot (inclusive) | `/api/history?start=2025-07-01&end=2025-07-22` |
| `/api/summary?limit=30`                     | Summary stats over N rows (avg, min, max) | `/api/summary?limit=30`              |

---

üì¶ **Response Examples**

**/api/latest**
```json
{
  "ts": "2025-07-23T17:00:00.000Z",
  "total_supply": "250000000000000",
  "locked_balance": "120000000000000",
  "circulating_supply": "130000000000000",
  "totalFormatted": "250,000,000",
  "lockedFormatted": "120,000,000",
  "circFormatted": "130,000,000",
  "pctLocked": 48
}
```

**/api/history?limit=3**
```json
{
  "count": 3,
  "data": [
    {
      "ts": "2025-07-23T17:00:00.000Z",
      "circulating_supply": "130000000000000",
      "circFormatted": "130,000,000",
      "pctLocked": 48
    },
    {
      "ts": "2025-07-22T17:00:00.000Z",
      "circulating_supply": "129500000000000",
      "circFormatted": "129,500,000",
      "pctLocked": 48.2
    }
  ]
}
```

**/api/summary?limit=30**
```json
{
  "count": 30,
  "average": {
    "circulating_supply": "129750000000000",
    "circFormatted": "129,750,000",
    "pctLocked": 48.1
  },
  "min": {
    "circulating_supply": "128000000000000",
    "circFormatted": "128,000,000"
  },
  "max": {
    "circulating_supply": "130000000000000",
    "circFormatted": "130,000,000"
  }
}
```

---

‚ö†Ô∏è **Error Responses**

| Code | Message                   | Example Body                        |
|------|---------------------------|-------------------------------------|
| 400  | Bad or missing parameters | {"error":"Invalid limit param"}     |
| 404  | No data (e.g. /latest)    | {"error":"No data"}                 |
| 405  | Unsupported method        | {"error":"Method not allowed"}      |
| 500  | Internal / Supabase error | {"error":"Database error"}          |

---

üß™ **Quick Testing**

```bash
# All history
curl https://your-vercel-url.vercel.app/api/history

# Last 7 snapshots
curl "https://your-vercel-url.vercel.app/api/history?limit=7"

# Specific date range
curl "https://your-vercel-url.vercel.app/api/history?start=2025-07-01&end=2025-07-22"

# Most recent
curl https://your-vercel-url.vercel.app/api/latest

# Summary of 30 snapshots
curl "https://your-vercel-url.vercel.app/api/summary?limit=30"
```

---

- Service role key lives only in GitHub & Vercel server envs (never in client bundles).
- API is read‚Äëonly; no writes exposed publicly.

---

## üßØ Troubleshooting

- **RPC 429 / timeouts**
  - Increase `BATCH_DELAY_MS`, reduce `BATCH_SIZE`, rotate RPC key.
- **Supabase error: relation circ_supply does not exist**
  - Run the migrate SQL in Supabase ‚Äî same class of setup error flagged in Offload README (`offload_daily` not found).
- **GitHub Action failing (env undefined)**
  - Confirm secrets are added in repo settings; Offload workflow requires Supabase + login envs in exactly this way.
- **API returns 500**
  - Likely Supabase connection/env issue; verify Vercel environment variables ‚Äî same root cause documented in Offload API troubleshooting.

---

## üì¶ Dependencies

Core:
- [@solana/web3.js](https://www.npmjs.com/package/@solana/web3.js)
- [@supabase/supabase-js](https://www.npmjs.com/package/@supabase/supabase-js)
- [dotenv](https://www.npmjs.com/package/dotenv)
